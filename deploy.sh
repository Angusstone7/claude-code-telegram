#!/bin/bash
# =============================================================================
# ğŸš€ Claude Code Telegram - One-Command Deploy Script
# =============================================================================
# Usage: curl -sSL https://raw.githubusercontent.com/your-username/claude-code-telegram/main/deploy.sh | bash
# Or:    ./deploy.sh
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Print colored output
info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
success() { echo -e "${GREEN}âœ… $1${NC}"; }
warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; exit 1; }

# Header
echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘       ğŸ“± Claude Code Telegram - Quick Deploy              â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check prerequisites
info "Checking prerequisites..."

if ! command -v docker &> /dev/null; then
    error "Docker is not installed. Please install Docker first: https://docs.docker.com/get-docker/"
fi

if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    error "Docker Compose is not installed. Please install Docker Compose first."
fi

success "Docker and Docker Compose are installed"

# Check if we're in the right directory or need to clone
if [ -f "docker-compose.yml" ] && [ -f "main.py" ]; then
    info "Running from existing installation directory"
    REPO_DIR="."
else
    # Clone repository
    REPO_DIR="claude-code-telegram"

    if [ -d "$REPO_DIR" ]; then
        warning "Directory '$REPO_DIR' already exists"
        read -p "Delete and re-clone? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -rf "$REPO_DIR"
        else
            cd "$REPO_DIR"
            REPO_DIR="."
        fi
    fi

    if [ "$REPO_DIR" != "." ]; then
        info "Cloning repository..."
        git clone https://github.com/your-username/claude-code-telegram.git "$REPO_DIR"
        cd "$REPO_DIR"
        success "Repository cloned"
    fi
fi

# Create .env file if it doesn't exist
if [ ! -f ".env" ]; then
    info "Creating configuration file..."

    echo ""
    echo -e "${YELLOW}Please provide the following information:${NC}"
    echo ""

    # Get Telegram Token
    read -p "ğŸ¤– Telegram Bot Token (from @BotFather): " TELEGRAM_TOKEN
    if [ -z "$TELEGRAM_TOKEN" ]; then
        error "Telegram token is required"
    fi

    # Choose AI Provider
    echo ""
    echo -e "${CYAN}ğŸ”‘ Choose AI Provider:${NC}"
    echo "  1) Anthropic (Claude API) - console.anthropic.com"
    echo "  2) ZhipuAI (GLM models) - open.bigmodel.cn"
    echo ""
    read -p "Enter choice [1-2]: " PROVIDER_CHOICE

    case $PROVIDER_CHOICE in
        2)
            PROVIDER="zhipuai"
            read -p "ğŸ”‘ ZhipuAI API Token: " API_KEY
            if [ -z "$API_KEY" ]; then
                error "ZhipuAI token is required"
            fi
            ;;
        *)
            PROVIDER="anthropic"
            read -p "ğŸ”‘ Anthropic API Key (sk-ant-...): " API_KEY
            if [ -z "$API_KEY" ]; then
                error "Anthropic API key is required"
            fi
            ;;
    esac

    # Get User ID
    echo ""
    echo -e "${CYAN}ğŸ†” Your Telegram User ID (from @userinfobot)${NC}"
    echo -e "   ${YELLOW}This user will be the bot admin${NC}"
    echo ""
    read -p "Enter your Telegram ID: " ALLOWED_USER_ID
    if [ -z "$ALLOWED_USER_ID" ]; then
        error "Telegram user ID is required"
    fi

    # Create .env file based on provider
    if [ "$PROVIDER" = "zhipuai" ]; then
        cat > .env << EOF
# =============================================================================
# Claude Code Telegram - Configuration (ZhipuAI)
# Generated by deploy.sh on $(date)
# =============================================================================

# Telegram
TELEGRAM_TOKEN=$TELEGRAM_TOKEN
ALLOWED_USER_ID=$ALLOWED_USER_ID

# ZhipuAI Provider
ANTHROPIC_BASE_URL=https://open.bigmodel.cn/api/anthropic
ANTHROPIC_AUTH_TOKEN=$API_KEY
ANTHROPIC_MODEL=glm-4.7
ANTHROPIC_DEFAULT_HAIKU_MODEL=glm-4.5-air
ANTHROPIC_DEFAULT_SONNET_MODEL=glm-4.7
ANTHROPIC_DEFAULT_OPUS_MODEL=glm-4.7

# Optional - uncomment to customize
# CLAUDE_WORKING_DIR=/root/projects
# LOG_LEVEL=INFO
EOF
        success "Configuration created for ZhipuAI"
    else
        cat > .env << EOF
# =============================================================================
# Claude Code Telegram - Configuration (Anthropic)
# Generated by deploy.sh on $(date)
# =============================================================================

# Telegram
TELEGRAM_TOKEN=$TELEGRAM_TOKEN
ALLOWED_USER_ID=$ALLOWED_USER_ID

# Anthropic Provider
ANTHROPIC_API_KEY=$API_KEY

# Optional - uncomment to customize
# ANTHROPIC_MODEL=claude-sonnet-4-20250514
# CLAUDE_WORKING_DIR=/root/projects
# LOG_LEVEL=INFO
EOF
        success "Configuration created for Anthropic"
    fi
else
    success ".env file already exists"
fi

# Create necessary directories
info "Creating directories..."
mkdir -p data logs projects claude_sessions
success "Directories created"

# Build and start
echo ""
info "Building and starting the bot..."
echo ""

if docker compose version &> /dev/null; then
    docker compose up -d --build
else
    docker-compose up -d --build
fi

# Wait for container to start
sleep 3

# Check status
echo ""
if docker ps | grep -q "claude_agent"; then
    success "Bot is running!"
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘                    ğŸ‰ Deployment Complete!                â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "  ğŸ“± Open Telegram and send ${YELLOW}/start${NC} to your bot"
    echo ""
    echo -e "  ${BLUE}Useful commands:${NC}"
    echo -e "    View logs:    ${YELLOW}docker-compose logs -f claude-bot${NC}"
    echo -e "    Restart:      ${YELLOW}docker-compose restart${NC}"
    echo -e "    Stop:         ${YELLOW}docker-compose down${NC}"
    echo ""
else
    warning "Container may not have started properly"
    echo ""
    echo "Check logs with: docker-compose logs claude-bot"
fi
