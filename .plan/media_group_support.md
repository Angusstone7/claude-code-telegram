# –ü–ª–∞–Ω: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–¥–∏–∞–≥—Ä—É–ø–ø (–∞–ª—å–±–æ–º–æ–≤)

## –¶–µ–ª—å
–ü–æ–∑–≤–æ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ/—Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–∞–ª—å–±–æ–º),
–∏ –≤—Å–µ –æ–Ω–∏ –±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏.

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚ùå –ú–µ–¥–∏–∞–≥—Ä—É–ø–ø—ã –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
- –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª –∏–∑ –∞–ª—å–±–æ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- –ï—Å—Ç—å –±–∞—Ç—á–∏–Ω–≥ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–æ –Ω–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: MediaGroupBatcher (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)
–°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π batcher –¥–ª—è –º–µ–¥–∏–∞–≥—Ä—É–ø–ø –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å `MessageBatcher`.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ª–æ–≥–∏–∫–æ–π
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

### –í–∞—Ä–∏–∞–Ω—Ç 2: aiogram-media-group
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `aiogram-media-group`.

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- –ú–µ–Ω—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–í–∞—Ä–∏–∞–Ω—Ç 1)

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å MediaGroupBatcher
**–§–∞–π–ª:** `presentation/middleware/media_group_batcher.py`

```python
@dataclass
class PendingMediaGroup:
    media_group_id: str
    messages: List[Message]  # –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–ª—å–±–æ–º–∞
    caption: Optional[str]   # Caption –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    timer_task: Optional[asyncio.Task]
    created_at: datetime

class MediaGroupBatcher:
    BATCH_DELAY = 0.5  # —Å–µ–∫—É–Ω–¥—ã (–≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∞–ª—å–±–æ–º–∞)

    async def add_message(self, message: Message, callback) -> bool:
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ batch –ø–æ media_group_id"""

    async def _process_group(self, media_group_id: str, callback):
        """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–±—Ä–∞–Ω–Ω—É—é –º–µ–¥–∏–∞–≥—Ä—É–ø–ø—É"""
```

### –®–∞–≥ 2: –ò–∑–º–µ–Ω–∏—Ç—å FileMessageHandler
**–§–∞–π–ª:** `presentation/handlers/message/file_handler.py`

–î–æ–±–∞–≤–∏—Ç—å:
```python
async def handle_media_group(self, messages: List[Message]) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∞–ª—å–±–æ–º (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ/—Ñ–∞–π–ª–æ–≤)"""
    # 1. –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã
    # 2. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∂–¥—ã–π —á–µ—Ä–µ–∑ file_processor_service
    # 3. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è Claude
    # 4. –ï—Å–ª–∏ –µ—Å—Ç—å caption - —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É
    # 5. –ï—Å–ª–∏ –Ω–µ—Ç - –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è reply
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å FileProcessorService
**–§–∞–π–ª:** `application/services/file_processor_service.py`

–î–æ–±–∞–≤–∏—Ç—å:
```python
def format_multiple_files_for_prompt(
    self,
    files: List[ProcessedFile],
    task: str,
    working_dir: str
) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""
```

### –®–∞–≥ 4: –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é handlers
**–§–∞–π–ª:** `presentation/handlers/message/coordinator.py`

```python
# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å handler –¥–ª—è –º–µ–¥–∏–∞–≥—Ä—É–ø–ø
router.message.register(
    handlers.handle_media_group_message,
    F.media_group_id,  # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å media_group_id
    StateFilter(None)
)
```

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å FileContextManager
**–§–∞–π–ª:** `presentation/handlers/state/file_context.py`

```python
def cache_files(self, message_id: int, files: List[ProcessedFile]):
    """–ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è reply"""

def pop_files(self, message_id: int) -> Optional[List[ProcessedFile]]:
    """–ü–æ–ª—É—á–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"""
```

### –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç—å TextHandler –¥–ª—è reply
**–§–∞–π–ª:** `presentation/handlers/message/text_handler.py`

–ò–∑–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É reply —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤.

## –ü–æ—Ä—è–¥–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏–π

1. `presentation/middleware/media_group_batcher.py` - **–°–û–ó–î–ê–¢–¨**
2. `application/services/file_processor_service.py` - –∏–∑–º–µ–Ω–∏—Ç—å
3. `presentation/handlers/state/file_context.py` - –∏–∑–º–µ–Ω–∏—Ç—å
4. `presentation/handlers/message/file_handler.py` - –∏–∑–º–µ–Ω–∏—Ç—å
5. `presentation/handlers/message/coordinator.py` - –∏–∑–º–µ–Ω–∏—Ç—å
6. `presentation/handlers/message/text_handler.py` - –∏–∑–º–µ–Ω–∏—Ç—å

## UI/UX

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–ª—å–±–æ–º–∞ –±–µ–∑ caption:
```
üìé –ü–æ–ª—É—á–µ–Ω–æ 3 —Ñ–∞–π–ª–∞:
  ‚Ä¢ image1.jpg (120 KB)
  ‚Ä¢ image2.jpg (85 KB)
  ‚Ä¢ document.pdf (1.2 MB)

–°–¥–µ–ª–∞–π—Ç–µ reply –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –∑–∞–¥–∞—á–∏.
```

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–ª—å–±–æ–º–∞ —Å caption:
```
üìé –§–∞–π–ª—ã: 3 —à—Ç (image1.jpg, image2.jpg, +1)
üìù –ó–∞–¥–∞—á–∞: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã

‚è≥ –ó–∞–ø—É—Å–∫–∞—é Claude Code...
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª—å–±–æ–º –∏–∑ 2-3 —Ñ–æ—Ç–æ –±–µ–∑ caption ‚Üí –¥–æ–ª–∂–µ–Ω –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å—Å—è
2. Reply –Ω–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–ª—å–±–æ–º ‚Üí –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª—å–±–æ–º —Å caption ‚Üí —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏
4. –°–º–µ—à–∞–Ω–Ω—ã–π –∞–ª—å–±–æ–º (—Ñ–æ—Ç–æ + –¥–æ–∫—É–º–µ–Ω—Ç—ã) ‚Üí –≤—Å–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
5. –û–¥–∏–Ω —Ñ–∞–π–ª —Å media_group_id=None ‚Üí –æ–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

## –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
- –®–∞–≥ 1 (MediaGroupBatcher): 30 –º–∏–Ω
- –®–∞–≥ 2 (FileMessageHandler): 30 –º–∏–Ω
- –®–∞–≥ 3 (FileProcessorService): 15 –º–∏–Ω
- –®–∞–≥ 4-6 (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è): 30 –º–∏–Ω
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 15 –º–∏–Ω

**–ò—Ç–æ–≥–æ: ~2 —á–∞—Å–∞**
