# Feature Specification: React Admin Panel

**Feature Branch**: `001-react-admin-panel`
**Created**: 2026-02-11
**Status**: Draft
**Input**: User description: "Полноценная админка на React JS с интерфейсом чата, проектов, задач и настроек, копирующая функциональность Telegram-бота. Привязка пользователей по Telegram ID."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Аутентификация и привязка к Telegram (Priority: P1)

Администратор открывает веб-панель в браузере и входит в систему, используя свои учётные данные. В профиле он указывает свой Telegram ID, что позволяет системе связать его веб-сессию с настройками и проектами из Telegram-бота. После привязки все проекты, контексты и настройки, созданные через Telegram, становятся доступны в веб-панели.

**Why this priority**: Без аутентификации и привязки к Telegram невозможно использовать все остальные функции. Это фундаментальная основа всей панели.

**Independent Test**: Можно протестировать, войдя в панель и указав Telegram ID — система должна показать проекты и настройки этого пользователя.

**Acceptance Scenarios**:

1. **Given** пользователь открывает веб-панель впервые, **When** он вводит корректные учётные данные, **Then** система аутентифицирует его и перенаправляет на дашборд с текущим проектом, метриками, статистикой использования и логами активности.
2. **Given** аутентифицированный пользователь без привязки, **When** он указывает Telegram ID в настройках профиля, **Then** система связывает его аккаунт с данными из Telegram-бота.
3. **Given** пользователь с привязанным Telegram ID, **When** он открывает раздел проектов, **Then** он видит все проекты, созданные через Telegram.
4. **Given** неавторизованный пользователь, **When** он пытается открыть любую страницу панели, **Then** система перенаправляет его на страницу входа.

---

### User Story 2 - Чат с Claude Code (Priority: P1)

Пользователь выбирает проект и начинает диалог с Claude Code прямо из веб-панели. Он пишет сообщения, получает ответы в реальном времени (streaming), одобряет или отклоняет запросы на использование инструментов (HITL), отвечает на уточняющие вопросы и утверждает планы — точно так же, как это работает в Telegram.

**Why this priority**: Чат с Claude Code — это ключевая функция бота. Без неё веб-панель не имеет практической ценности.

**Independent Test**: Можно отправить сообщение Claude и получить ответ в streaming-режиме, одобрить запрос на использование инструмента.

**Acceptance Scenarios**:

1. **Given** пользователь находится в проекте с выбранным контекстом, **When** он отправляет сообщение, **Then** ответ Claude отображается в реальном времени (streaming).
2. **Given** Claude запрашивает разрешение на действие (HITL), **When** пользователь видит запрос, **Then** он может одобрить или отклонить его с подробностями операции.
3. **Given** Claude задаёт уточняющий вопрос, **When** пользователь видит вопрос с вариантами ответов, **Then** он может выбрать вариант или написать произвольный ответ.
4. **Given** Claude предлагает план действий, **When** пользователь видит план, **Then** он может утвердить, отклонить или попросить изменения.
5. **Given** задача Claude выполняется, **When** пользователь нажимает кнопку отмены, **Then** выполнение задачи прерывается.
6. **Given** пользователь работает в проекте A, **When** он открывает новое окно чата для проекта B, **Then** оба чата работают параллельно и независимо.
7. **Given** в текущей сессии уже выполняется задача Claude, **When** пользователь пытается отправить ещё одно сообщение в ту же сессию, **Then** система показывает уведомление «задача уже выполняется» и блокирует отправку.
8. **Given** пользователь хочет передать файл Claude, **When** он прикрепляет файл (документ или изображение) к сообщению в чате, **Then** файл загружается на сервер и передаётся Claude как контекст.

---

### User Story 3 - Управление проектами и контекстами (Priority: P2)

Пользователь просматривает список своих проектов, переключается между ними, создаёт новые проекты, управляет контекстами разговоров (создание, переключение, удаление), а также управляет переменными контекста — локальными и глобальными.

**Why this priority**: Управление проектами и контекстами необходимо для организации работы, но вторично по отношению к самому чату с Claude.

**Independent Test**: Можно создать проект, добавить контекст, переключиться между контекстами и увидеть различную историю сообщений.

**Acceptance Scenarios**:

1. **Given** пользователь на главной странице, **When** он открывает раздел проектов, **Then** он видит список всех своих проектов с указанием текущего активного.
2. **Given** пользователь в разделе проектов, **When** он создаёт новый проект с именем, **Then** проект появляется в списке и доступен для работы.
3. **Given** пользователь в проекте, **When** он открывает список контекстов, **Then** он видит все контексты с количеством сообщений и статусом.
4. **Given** пользователь переключает контекст, **When** он выбирает другой контекст, **Then** история чата обновляется и показывает сообщения выбранного контекста.
5. **Given** пользователь управляет переменными, **When** он добавляет переменную с именем, значением и описанием, **Then** переменная сохраняется и доступна для Claude.

---

### User Story 4 - Файловый браузер (Priority: P2)

Пользователь просматривает файловую структуру проекта, навигирует по папкам, выбирает рабочую директорию и создаёт новые папки — аналогично файловому браузеру в Telegram-боте.

**Why this priority**: Файловый браузер критичен для навигации по проектам, но может работать через существующий механизм выбора проекта.

**Independent Test**: Можно открыть файловый браузер, перейти по папкам, выбрать рабочую директорию проекта.

**Acceptance Scenarios**:

1. **Given** пользователь в файловом браузере, **When** он открывает директорию, **Then** он видит список файлов и подпапок.
2. **Given** пользователь просматривает папки, **When** он нажимает на подпапку, **Then** он переходит внутрь и видит её содержимое.
3. **Given** пользователь нашёл нужную папку, **When** он выбирает её как рабочую директорию, **Then** система устанавливает её для текущего проекта.

---

### User Story 5 - Настройки и управление аккаунтом (Priority: P3)

Пользователь настраивает параметры работы с Claude Code: выбирает backend (SDK/CLI), включает/выключает YOLO-режим, настраивает режим стриминга, выбирает модель, управляет учётными данными и языком интерфейса.

**Why this priority**: Настройки улучшают пользовательский опыт, но система работает с разумными значениями по умолчанию.

**Independent Test**: Можно переключить YOLO-режим и убедиться, что запросы на разрешения больше не появляются.

**Acceptance Scenarios**:

1. **Given** пользователь в разделе настроек, **When** он переключает YOLO-режим, **Then** режим сохраняется и применяется к последующим запросам Claude.
2. **Given** пользователь в настройках аккаунта, **When** он выбирает другую модель AI, **Then** следующие запросы используют выбранную модель.
3. **Given** пользователь выбирает backend, **When** он переключает между SDK и CLI, **Then** система использует выбранный backend для взаимодействия с Claude.
4. **Given** пользователь в настройках языка, **When** он выбирает другой язык, **Then** интерфейс переключается на выбранный язык.

---

### User Story 6 - Мониторинг системы и Docker (Priority: P3)

Пользователь просматривает системные метрики (CPU, память, диск), управляет Docker-контейнерами (запуск, остановка, перезагрузка, логи) и проверяет статус Claude Code (SDK/CLI доступность).

**Why this priority**: Мониторинг и управление Docker — вспомогательные функции, которые нужны не при каждом использовании.

**Independent Test**: Можно открыть дашборд и увидеть текущие метрики CPU/RAM/Disk, список контейнеров с их статусами.

**Acceptance Scenarios**:

1. **Given** пользователь в разделе мониторинга, **When** он открывает метрики, **Then** он видит актуальные данные CPU, памяти, диска с визуальными индикаторами.
2. **Given** пользователь в разделе Docker, **When** он видит список контейнеров, **Then** каждый контейнер показывает статус (running/stopped), образ, время работы.
3. **Given** пользователь управляет контейнером, **When** он нажимает «Перезагрузить», **Then** контейнер перезагружается и статус обновляется.
4. **Given** пользователь хочет посмотреть логи контейнера, **When** он открывает логи, **Then** он видит последние записи с возможностью указать количество строк.

---

### User Story 7 - Плагины Claude Code (Priority: P3)

Пользователь просматривает список доступных плагинов Claude Code, видит их статус (включён/отключён), описание и доступные команды.

**Why this priority**: Информация о плагинах полезна, но не влияет на основную функциональность чата.

**Independent Test**: Можно открыть раздел плагинов и увидеть список с описаниями и статусами.

**Acceptance Scenarios**:

1. **Given** пользователь в разделе плагинов, **When** он открывает список, **Then** он видит все плагины с названиями, описаниями и статусами.
2. **Given** пользователь выбирает плагин, **When** он открывает детали, **Then** он видит доступные slash-команды и описание каждой.

---

### User Story 8 - SSH-команды (Priority: P3)

Пользователь выполняет SSH-команды на сервере через веб-панель — аналогично функции SSH-команд в Telegram-боте. Он вводит команду, видит результат выполнения, может просмотреть историю команд.

**Why this priority**: SSH-команды — вспомогательная функция для администрирования сервера, не связанная с основным workflow чата с Claude.

**Independent Test**: Можно ввести команду `ls -la` и увидеть вывод результата в веб-панели.

**Acceptance Scenarios**:

1. **Given** пользователь в разделе SSH, **When** он вводит команду и нажимает «Выполнить», **Then** результат выполнения отображается в реальном времени.
2. **Given** пользователь выполнил несколько команд, **When** он открывает историю, **Then** он видит список предыдущих команд с результатами.
3. **Given** команда выполняется долго, **When** пользователь нажимает «Отмена», **Then** выполнение прерывается.

---

### User Story 9 - GitLab-интеграция (Priority: P3)

Пользователь просматривает информацию о GitLab-репозиториях: список проектов, пайплайны, статусы CI/CD — аналогично GitLab-функциям в Telegram-боте.

**Why this priority**: GitLab-интеграция помогает отслеживать CI/CD, но не является основной функцией.

**Independent Test**: Можно открыть раздел GitLab и увидеть список проектов с последними пайплайнами.

**Acceptance Scenarios**:

1. **Given** пользователь в разделе GitLab, **When** он открывает список проектов, **Then** он видит репозитории с последними коммитами и статусами пайплайнов.
2. **Given** пользователь выбирает проект, **When** он открывает пайплайны, **Then** он видит список пайплайнов со статусами (success/failed/running).
3. **Given** пользователь просматривает пайплайн, **When** он открывает детали, **Then** он видит этапы (stages) и их статусы.

---

### Edge Cases

- Что происходит, если пользователь указывает Telegram ID, уже привязанный к другому аккаунту в веб-панели?
- Что происходит при потере соединения во время streaming-ответа Claude?
- Как система обрабатывает одновременную работу пользователя в Telegram и в веб-панели в рамках одной сессии (уведомление о блокировке)?
- Что происходит, если HITL-запрос истекает по тайм-ауту (5 минут) без ответа?
- Как отображается длинный ответ Claude с блоками кода, markdown-форматированием и результатами инструментов?
- Что происходит при попытке входа с неправильными учётными данными 5+ раз подряд?
- Как система обрабатывает разрыв WebSocket-соединения и переподключение?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА предоставлять аутентификацию пользователей с защищённым входом в веб-панель. Регистрация закрытая — только существующий администратор может создавать новые аккаунты.
- **FR-002**: Система ДОЛЖНА позволять пользователю указывать Telegram ID в профиле для привязки к существующему аккаунту бота. Верификация TG ID не требуется — все пользователи доверенные.
- **FR-003**: Система ДОЛЖНА обеспечивать двустороннюю синхронизацию данных — изменения в Telegram должны отражаться в веб-панели и наоборот.
- **FR-004**: Система ДОЛЖНА отображать интерфейс чата с Claude Code, поддерживающий streaming-ответы в реальном времени через WebSocket-соединение.
- **FR-005**: Система ДОЛЖНА поддерживать HITL-взаимодействие — отображение запросов на разрешение с кнопками одобрения/отклонения. HITL-запросы отправляются одновременно во все подключённые интерфейсы (Telegram и веб-панель); принимается первый ответ, остальные интерфейсы получают уведомление, что запрос уже обработан.
- **FR-006**: Система ДОЛЖНА поддерживать обработку уточняющих вопросов от Claude с выбором варианта или произвольным вводом.
- **FR-007**: Система ДОЛЖНА поддерживать одобрение/отклонение планов Claude с отображением содержимого плана.
- **FR-008**: Система ДОЛЖНА предоставлять полное управление проектами: список, создание, переключение, удаление.
- **FR-009**: Система ДОЛЖНА предоставлять управление контекстами: список, создание, переключение, удаление, очистка.
- **FR-010**: Система ДОЛЖНА предоставлять управление переменными контекста: локальные и глобальные переменные с CRUD-операциями.
- **FR-011**: Система ДОЛЖНА предоставлять файловый браузер с навигацией по папкам в рамках разрешённых директорий.
- **FR-012**: Система ДОЛЖНА отображать системные метрики (CPU, память, диск) с визуальными индикаторами.
- **FR-013**: Система ДОЛЖНА предоставлять управление Docker-контейнерами: список, запуск, остановка, перезагрузка, просмотр логов.
- **FR-014**: Система ДОЛЖНА предоставлять страницу настроек с управлением: YOLO-режим, step streaming, выбор backend, выбор модели, язык интерфейса. Настройки единые — изменение в одном интерфейсе (веб/Telegram) применяется ко всем интерфейсам пользователя.
- **FR-015**: Система ДОЛЖНА отображать информацию о плагинах Claude Code с их статусами и доступными командами.
- **FR-016**: Система ДОЛЖНА обеспечивать возможность отмены выполняющейся задачи Claude.
- **FR-017**: Система ДОЛЖНА корректно отображать markdown, блоки кода с подсветкой синтаксиса и результаты инструментов в чате.
- **FR-018**: Система ДОЛЖНА поддерживать мультиязычный интерфейс (русский, английский, китайский).
- **FR-019**: Привязка Telegram ID ДОЛЖНА быть уникальной — один Telegram ID может быть привязан только к одному веб-аккаунту.
- **FR-020**: Система ДОЛЖНА корректно обрабатывать конкурентную работу из Telegram и веб-панели одного пользователя: при попытке отправить запрос в сессию, где уже выполняется задача, показывать уведомление «задача уже выполняется» и блокировать отправку до завершения.
- **FR-021**: Веб-панель ДОЛЖНА поддерживать множественные окна чатов — пользователь может одновременно работать с несколькими проектами/сессиями в параллельных вкладках.
- **FR-022**: Параллельные запросы Claude в разных проектах/сессиях ДОЛЖНЫ выполняться независимо друг от друга без взаимной блокировки.
- **FR-023**: Система ДОЛЖНА предоставлять выполнение SSH-команд на сервере с отображением результатов и историей команд.
- **FR-024**: Система ДОЛЖНА предоставлять GitLab-интеграцию: список проектов, пайплайны, статусы CI/CD.
- **FR-025**: Система ДОЛЖНА поддерживать загрузку файлов (документы, изображения) в чат веб-панели для передачи Claude как контекста — аналогично отправке файлов в Telegram.
- **FR-026**: Главная страница (дашборд) ДОЛЖНА отображать: текущий проект, последние чаты, системные метрики (CPU/RAM/Disk), статус Claude Code, статистику использования (количество запросов, стоимость), графики нагрузки и лог последних действий.

### Key Entities

- **WebUser**: Пользователь веб-панели с учётными данными, профилем и привязкой к Telegram ID. Связан с существующей сущностью User через Telegram ID.
- **Project**: Рабочий проект с именем, путём и набором контекстов. Общий между Telegram и веб-панелью.
- **ProjectContext**: Контекст разговора в рамках проекта, содержащий историю сообщений и переменные. Общий между интерфейсами.
- **ChatMessage**: Сообщение в чате (от пользователя или от Claude), включая текст, результаты инструментов, запросы HITL.
- **ContextVariable**: Переменная контекста (локальная или глобальная) с именем, значением и описанием.
- **ToolPermissionRequest**: Запрос на разрешение использования инструмента (HITL) с деталями операции и статусом ожидания/одобрения/отклонения.

## Clarifications

### Session 2026-02-11

- Q: Как создаются учётные записи веб-панели? → A: Закрытая регистрация — только существующий администратор создаёт аккаунты вручную.
- Q: Поведение при конкурентной работе из Telegram и веб-панели? → A: Блокировка с уведомлением в рамках одной сессии/проекта. Но в веб-панели пользователь может открыть несколько окон чатов и работать параллельно в разных проектах/сессиях. В Telegram остаётся текущая логика (один запрос за раз).
- Q: Куда приходят HITL-запросы при работе из веб-панели? → A: В оба интерфейса одновременно (Telegram и веб-панель). Первый ответ принимается, второй интерфейс получает уведомление, что запрос уже обработан.
- Q: Транспорт для streaming и HITL в веб-панели? → A: WebSocket — полноценная двусторонняя связь для streaming-ответов, HITL-запросов, уведомлений и обновлений.
- Q: Развёртывание веб-панели? → A: В том же Docker-контейнере, что и бот. FastAPI раздаёт собранную статику SPA рядом с API.

### Session 2026-02-11 (post-plan)

- Q: Включать ли SSH-команды и GitLab-интеграцию в текущую версию веб-панели? → A: Да, SSH и GitLab включены в текущую версию.
- Q: Синхронизация настроек между веб-панелью и Telegram? → A: Полностью единые — изменение в одном интерфейсе применяется ко всем.
- Q: Поддержка загрузки файлов в чат веб-панели? → A: Да, документы и изображения — аналогично Telegram.
- Q: Верификация Telegram ID при привязке? → A: Без верификации — доверенный админ вводит ID, система принимает.
- Q: Содержимое главной страницы (дашборд)? → A: Полный дашборд — текущий проект, последние чаты, метрики, статистика использования, графики, логи активности.

## Assumptions

- Существующий REST API (FastAPI) будет расширен для покрытия всех функций, необходимых веб-панели.
- Аутентификация в веб-панели будет сессионной (JWT token-based), отдельной от аутентификации Telegram-бота.
- Streaming-ответы от Claude и все real-time взаимодействия (HITL, уведомления, обновления статусов) будут доставляться через WebSocket.
- Веб-панель будет развёрнута в том же Docker-контейнере, что и бот. FastAPI раздаёт собранную статику SPA рядом с REST API и WebSocket-эндпоинтами.
- Один пользователь может работать одновременно из Telegram и из веб-панели. Блокировка действует только в рамках одной сессии — параллельные запросы в разных проектах/сессиях разрешены.
- Файловый браузер ограничен директорией `/root/projects` (серверная валидация).
- Все пользователи веб-панели считаются доверенными (админами), аналогично ограничению `ALLOWED_USER_ID` в Telegram.
- SSH-команды и GitLab-интеграция включены в текущую версию веб-панели.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователь может войти в веб-панель, привязать Telegram ID и увидеть свои проекты менее чем за 2 минуты.
- **SC-002**: Сообщения в чате с Claude начинают отображаться в реальном времени (streaming) менее чем через 2 секунды после отправки.
- **SC-003**: Все функции Telegram-бота (проекты, контексты, переменные, настройки, HITL, Docker, метрики, плагины, SSH-команды, GitLab-интеграция) доступны в веб-панели.
- **SC-004**: HITL-запросы отображаются в веб-панели в течение 1 секунды после генерации Claude.
- **SC-005**: Изменения, внесённые через Telegram (создание проекта, переключение контекста), отображаются в веб-панели при следующем обращении к данным.
- **SC-006**: 95% пользователей успешно привязывают Telegram ID и начинают чат при первом использовании без обращения в поддержку.
- **SC-007**: Веб-панель корректно отображает markdown-контент, блоки кода с подсветкой синтаксиса и результаты выполнения инструментов.
- **SC-008**: Веб-панель поддерживает одновременную работу минимум 5 пользователей без деградации производительности.
