version: '3.8'

services:
  claude-bot:
    image: ${BOT_IMAGE_NAME:-ubuntu-claude-bot:latest}
    container_name: ${BOT_CONTAINER_NAME:-claude_agent}
    restart: always
    environment:
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_AUTH_TOKEN}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-3-5-sonnet-20241022}
      - ANTHROPIC_DEFAULT_HAIKU_MODEL=${ANTHROPIC_DEFAULT_HAIKU_MODEL}
      - ANTHROPIC_DEFAULT_SONNET_MODEL=${ANTHROPIC_DEFAULT_SONNET_MODEL}
      - ANTHROPIC_DEFAULT_OPUS_MODEL=${ANTHROPIC_DEFAULT_OPUS_MODEL}
      - ALLOWED_USER_ID=${ALLOWED_USER_ID}
      - HOST_USER=${HOST_USER:-root}
      - SSH_HOST=${SSH_HOST:-host.docker.internal}
      - SSH_PORT=${SSH_PORT:-22}
      - SSH_KEY_PATH=${SSH_KEY_PATH:-/app/bot_key}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./data/bot.db}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-false}
    volumes:
      # SSH key for host access (read-only)
      - ./bot_key:/app/bot_key:ro
      # Persistent data
      - ./data:/app/data
      - ./logs:/app/logs
      # Projects directory - persists across container rebuilds
      - ./projects:/root/projects
      # Claude Code sessions - preserves conversation history and context compression
      - ./claude_sessions:/root/.claude
    extra_hosts:
      - "host.docker.internal:host-gateway"
